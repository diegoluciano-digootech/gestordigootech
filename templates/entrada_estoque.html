{% extends 'base.html' %}

{% block content %}
<form action="{{ url_for('entrada_estoque') }}" method="POST">
    <div class="card shadow-sm mb-4">
        <div class="card-header"><h2 class="h5 mb-0">Registrar Entrada de Estoque</h2></div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3 mb-3">
                    <label for="data_entrada" class="form-label">Data da Entrada</label>
                    <input type="date" class="form-control" id="data_entrada" name="data_entrada" value="{{ today_date.strftime('%Y-%m-%d') }}" required>
                </div>
                <div class="col-md-9 mb-3">
                    <label for="fornecedor_id" class="form-label">Fornecedor</label>
                    <select class="form-select" id="fornecedor_id" name="fornecedor_id">
                        <option value="">(Compra sem fornecedor específico)</option>
                        {% for fornecedor in fornecedores %}
                            <option value="{{ fornecedor.id }}">{{ fornecedor.razao_social }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="mb-3">
                <label for="observacao" class="form-label">Observação / Nº da Nota</label>
                <input type="text" class="form-control" id="observacao" name="observacao">
            </div>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-header"><h2 class="h5 mb-0">Itens da Entrada</h2></div>
        <div class="card-body">
            <table class="table">
                <thead>
                    <tr>
                        <th style="width: 50%;">Produto</th>
                        <th>Quantidade</th>
                        <th>Custo Unitário</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="itens-container">
                    </tbody>
            </table>
            <button type="button" id="add-item-btn" class="btn btn-secondary">Adicionar Item</button>
        </div>
        <div class="card-footer text-end">
            <a href="{{ url_for('estoque') }}" class="btn btn-light me-2">Cancelar</a>
            <button type="submit" class="btn btn-primary">Salvar Entrada de Estoque</button>
        </div>
    </div>
</form>

<template id="item-template">
    <tr>
        <td>
            <select class="form-select select-produto" name="produto_id[]" required>
                <option></option> {% for produto in produtos %}
                    <option value="{{ produto.id }}" data-custo="{{ produto.valor_custo }}">{{ produto.descricao }} (SKU: {{ produto.sku or 'N/A' }})</option>
                {% endfor %}
            </select>
        </td>
        <td><input type="number" class="form-control" name="quantidade[]" value="1" min="1" required></td>
        <td>
            <div class="input-group">
                <span class="input-group-text">R$</span>
                <input type="number" step="0.01" class="form-control input-custo" name="custo[]" required>
            </div>
        </td>
        <td><button type="button" class="btn btn-danger btn-sm remove-item-btn">X</button></td>
    </tr>
</template>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    $('#fornecedor_id').select2({ theme: "bootstrap-5", placeholder: "Selecione um fornecedor" });

    const container = $('#itens-container');
    const template = $('#item-template').html();

    function initializeSelect2(element) {
        $(element).select2({
            theme: "bootstrap-5",
            placeholder: "Digite para buscar um produto..."
        });
    }

    $('#add-item-btn').on('click', function() {
        container.append(template);
        initializeSelect2(container.find('.select-produto').last());
    });

    container.on('click', '.remove-item-btn', function() {
        $(this).closest('tr').remove();
    });

    container.on('change', '.select-produto', function() {
        const selectedOption = $(this).find('option:selected');
        const custo = selectedOption.data('custo') || 0;
        $(this).closest('tr').find('.input-custo').val(parseFloat(custo).toFixed(2));
    });

    // Adiciona a primeira linha automaticamente ao carregar a página
    $('#add-item-btn').trigger('click');
});
</script>
{% endblock %}