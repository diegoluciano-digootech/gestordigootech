{% extends 'base.html' %}

{% block content %}
<div class="card shadow-sm mb-4">
    <div class="card-header"><h2 class="h5 mb-0">Adicionar Novo Fornecedor</h2></div>
    <div class="card-body">
        <form action="{{ url_for('gerenciar_fornecedores') }}" method="POST">
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label for="cnpj" class="form-label">CNPJ</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="cnpj" name="cnpj" maxlength="18">
                        <button class="btn btn-outline-secondary" type="button" id="btnConsultarCnpj">Buscar Dados</button>
                    </div>
                </div>
                <div class="col-md-8 mb-3">
                    <label for="razao_social" class="form-label">Razão Social</label>
                    <input type="text" class="form-control" id="razao_social" name="razao_social" required>
                </div>
            </div>
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label for="nome_fantasia" class="form-label">Nome Fantasia</label>
                    <input type="text" class="form-control" id="nome_fantasia" name="nome_fantasia">
                </div>
                <div class="col-md-4 mb-3">
                    <label for="telefone" class="form-label">Telefone</label>
                    <input type="text" class="form-control" id="telefone" name="telefone" maxlength="15">
                </div>
                <div class="col-md-4 mb-3">
                    <label for="email" class="form-label">E-mail</label>
                    <input type="email" class="form-control" id="email" name="email">
                </div>
            </div>
            <hr>
            <div class="row">
                <div class="col-md-3 mb-3">
                    <label for="cep" class="form-label">CEP</label>
                    <input type="text" class="form-control" id="cep" name="cep" maxlength="9">
                </div>
                <div class="col-md-7 mb-3">
                    <label for="rua" class="form-label">Rua</label>
                    <input type="text" class="form-control" id="rua" name="rua">
                </div>
                <div class="col-md-2 mb-3">
                    <label for="numero" class="form-label">N°</label>
                    <input type="text" class="form-control" id="numero" name="numero">
                </div>
            </div>
            <div class="row">
                <div class="col-md-5 mb-3">
                    <label for="bairro" class="form-label">Bairro</label>
                    <input type="text" class="form-control" id="bairro" name="bairro">
                </div>
                <div class="col-md-5 mb-3">
                    <label for="cidade" class="form-label">Cidade</label>
                    <input type="text" class="form-control" id="cidade" name="cidade">
                </div>
                <div class="col-md-2 mb-3">
                    <label for="uf" class="form-label">UF</label>
                    <input type="text" class="form-control" id="uf" name="uf" maxlength="2">
                </div>
            </div>
            <button type="submit" class="btn btn-primary">Cadastrar Fornecedor</button>
        </form>
    </div>
</div>

<div class="card shadow-sm">
    <div class="card-header"><h2 class="h5 mb-0">Fornecedores Cadastrados</h2></div>
    <div class="card-body">
        <table class="table table-hover">
            <thead>
                <tr>
                    <th scope="col">Razão Social</th>
                    <th scope="col">Nome Fantasia</th>
                    <th scope="col">CNPJ</th>
                    <th scope="col">Contato</th>
                </tr>
            </thead>
            <tbody>
                {% for fornecedor in fornecedores %}
                <tr>
                    <td>{{ fornecedor.razao_social }}</td>
                    <td>{{ fornecedor.nome_fantasia }}</td>
                    <td>{{ fornecedor.cnpj }}</td>
                    <td>{{ fornecedor.telefone }} / {{ fornecedor.email }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/imask"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {

    // --- LÓGICA PARA CONSULTA DE CNPJ ---
    document.getElementById('btnConsultarCnpj').addEventListener('click', function() {
        const cnpjInput = document.getElementById('cnpj');
        const btn = this;
        const cnpjLimpo = cnpjInput.value.replace(/\D/g, '');

        if (cnpjLimpo.length !== 14) {
            alert('Por favor, digite um CNPJ válido com 14 dígitos.');
            return;
        }

        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';

        fetch(`/consulta-cnpj/${cnpjLimpo}`)
            .then(response => response.json())
            .then(data => {
                if (data.erro) {
                    alert('Erro: ' + data.erro);
                } else {
                    document.getElementById('razao_social').value = data.razao_social || '';
                    document.getElementById('nome_fantasia').value = data.nome_fantasia || '';
                    document.getElementById('email').value = data.email || '';
                    document.getElementById('cep').value = data.cep || '';
                    document.getElementById('rua').value = data.logradouro || '';
                    document.getElementById('numero').value = data.numero || '';
                    document.getElementById('bairro').value = data.bairro || '';
                    document.getElementById('cidade').value = data.municipio || '';
                    document.getElementById('uf').value = data.uf || '';
                    // Dispara a máscara de CEP e foca no campo de número
                    IMask(document.getElementById('cep'), { mask: '00000-000' }).value = data.cep || '';
                    document.getElementById('numero').focus();
                }
            })
            .catch(error => {
                console.error('Erro na requisição:', error);
                alert('Ocorreu um erro ao tentar buscar os dados do CNPJ.');
            })
            .finally(() => {
                btn.disabled = false;
                btn.innerHTML = 'Buscar Dados';
            });
    });

    // --- LÓGICA PARA CONSULTA DE CEP ---
    document.getElementById('cep').addEventListener('blur', function() {
        const cepLimpo = this.value.replace(/\D/g, '');
        if (cepLimpo.length === 8) {
            fetch(`/consulta-cep/${cepLimpo}`)
                .then(response => response.json())
                .then(data => {
                    if (!data.erro) {
                        document.getElementById('rua').value = data.street || '';
                        document.getElementById('bairro').value = data.neighborhood || '';
                        document.getElementById('cidade').value = data.city || '';
                        document.getElementById('uf').value = data.state || '';
                        document.getElementById('numero').focus();
                    }
                });
        }
    });

    // --- MÁSCARAS DE CAMPO ---
    IMask(document.getElementById('cnpj'), { mask: '00.000.000/0000-00' });
    IMask(document.getElementById('cep'), { mask: '00000-000' });
    IMask(document.getElementById('telefone'), {
        mask: [ { mask: '(00) 0000-0000' }, { mask: '(00) 00000-0000' } ]
    });
});
</script>
{% endblock %}