{% extends 'base.html' %}

{% block content %}
<h1 class="h3 mb-3">Relatório de Ordens de Serviço</h1>

<div class="card shadow-sm mb-4">
    <div class="card-header">Filtros do Relatório</div>
    <div class="card-body">
        <form method="GET" action="{{ url_for('relatorio_os') }}">
            <div class="row align-items-end g-3">
                <div class="col-md-3">
                    <label for="data_inicio" class="form-label">Data de Início</label>
                    <input type="date" class="form-control" id="data_inicio" name="data_inicio" value="{{ data_inicio or '' }}">
                </div>
                <div class="col-md-3">
                    <label for="data_fim" class="form-label">Data Final</label>
                    <input type="date" class="form-control" id="data_fim" name="data_fim" value="{{ data_fim or '' }}">
                </div>
                <div class="col-md-3">
                    <label for="cliente_id" class="form-label">Cliente</label>
                    <select id="cliente_id" name="cliente_id" class="form-select">
                        <option value="todos">Todos</option>
                        {% for cliente in todos_clientes %}
                            <option value="{{ cliente.id }}" {% if cliente_id_filtro == cliente.id|string %}selected{% endif %}>{{ cliente.nome_exibicao }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="status" class="form-label">Status</label>
                    <select id="status" name="status" class="form-select">
                        <option value="todas" {% if status_filtro == 'todas' %}selected{% endif %}>Todas</option>
                        <option value="Aberta" {% if status_filtro == 'Aberta' %}selected{% endif %}>Abertas</option>
                        <option value="Finalizada" {% if status_filtro == 'Finalizada' %}selected{% endif %}>Finalizadas</option>
                    </select>
                </div>
                <div class="col-md-1">
                    <button type="submit" class="btn btn-primary w-100">Filtrar</button>
                </div>
            </div>
        </form>
    </div>
</div>

<div class="card shadow-sm">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span>Resultados</span>
        <div>
            <button class="btn btn-danger btn-sm" onclick="exportarRelatorio('pdf')">Exportar PDF dos Selecionados</button>
            <button class="btn btn-success btn-sm" onclick="exportarRelatorio('excel')">Exportar Excel dos Selecionados</button>
        </div>
    </div>
    <div class="card-body">
        <table class="table table-hover">
            <thead>
                <tr>
                    <th scope="col" style="width: 1%;"><input class="form-check-input" type="checkbox" id="selectAll"></th>
                    <th scope="col"><a href="{{ url_for('relatorio_os', sort_by='id', direction='asc' if sort_by == 'id' and direction == 'desc' else 'desc', **request.args) }}" class="text-decoration-none text-dark">ID {% if sort_by == 'id' %}{% if direction == 'asc' %}▲{% else %}▼{% endif %}{% endif %}</a></th>
                    <th scope="col"><a href="{{ url_for('relatorio_os', sort_by='cliente', direction='asc' if sort_by == 'cliente' and direction == 'desc' else 'desc', **request.args) }}" class="text-decoration-none text-dark">Cliente {% if sort_by == 'cliente' %}{% if direction == 'asc' %}▲{% else %}▼{% endif %}{% endif %}</a></th>
                    <th scope="col"><a href="{{ url_for('relatorio_os', sort_by='data_criacao', direction='asc' if sort_by == 'data_criacao' and direction == 'desc' else 'desc', **request.args) }}" class="text-decoration-none text-dark">Data {% if sort_by == 'data_criacao' %}{% if direction == 'asc' %}▲{% else %}▼{% endif %}{% endif %}</a></th>
                    <th scope="col">Status</th>
                    <th class="text-end" scope="col">Valor Total</th>
                </tr>
            </thead>
            <tbody>
                {% for ordem in ordens %}
                <tr>
                    <td><input class="form-check-input os-checkbox" type="checkbox" value="{{ ordem.id }}"></td>
                    <td>{{ ordem.id }}</td>
                    <td><a href="{{ url_for('detalhe_os', id=ordem.id) }}">{{ ordem.cliente.nome_exibicao }}</a></td>
                    <td>{{ ordem.data_criacao.strftime('%d/%m/%Y') }}</td>
                    <td>
                        {% if ordem.status == 'Aberta' %}<span class="badge bg-warning">{{ ordem.status }}</span>{% else %}<span class="badge bg-success">{{ ordem.status }}</span>{% endif %}
                    </td>
                    <td class="text-end">R$ {{ "%.2f"|format(ordem.valor_total) }}</td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="6" class="text-center">Nenhuma Ordem de Serviço encontrada com os filtros selecionados.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() {
        // Ativa o Select2 para o campo de cliente
        $('#cliente_id').select2({
            theme: "bootstrap-5"
        });

        // Lógica para o "Marcar Todos"
        $('#selectAll').on('click', function() {
            $('.os-checkbox').prop('checked', this.checked);
        });

        // Lógica para desmarcar o "Marcar Todos" se uma caixa for desmarcada
        $('.os-checkbox').on('click', function() {
            if (!this.checked) {
                $('#selectAll').prop('checked', false);
            }
        });
    });

    // Função de exportação
    function exportarRelatorio(formato) {
        let checkboxes = document.querySelectorAll('.os-checkbox:checked');
        let idsSelecionados = Array.from(checkboxes).map(cb => cb.value);

        if (idsSelecionados.length === 0) {
            alert('Por favor, selecione pelo menos uma Ordem de Serviço para exportar.');
            return;
        }

        let data_inicio = document.getElementById('data_inicio').value;
        let data_fim = document.getElementById('data_fim').value;
        let status = document.getElementById('status').value;
        let cliente_id = document.getElementById('cliente_id').value;
        
        let baseUrl = (formato === 'pdf') ? "{{ url_for('relatorio_os_pdf') }}" : "{{ url_for('relatorio_os_excel') }}";
        let urlFinal = `${baseUrl}?data_inicio=${data_inicio}&data_fim=${data_fim}&status=${status}&cliente_id=${cliente_id}&ids=${idsSelecionados.join(',')}`;

        window.open(urlFinal, '_blank');
    }
</script>
{% endblock %}