{% extends 'base.html' %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h3">Detalhes do Orçamento #{{ orcamento.id }}</h1>
    <div>
        <a href="{{ url_for('listar_orcamentos') }}" class="btn btn-secondary">Voltar para a Lista</a>
        {% if orcamento.status == 'Em Aberto' %}
        <form action="{{ url_for('converter_orcamento_para_os', id=orcamento.id) }}" method="POST" class="d-inline" onsubmit="return confirm('Deseja converter este orçamento em uma Ordem de Serviço? Esta ação dará baixa no estoque dos itens.');">
            <button type="submit" class="btn btn-success">Converter em O.S.</button>
        </form>
        {% endif %}
    </div>
</div>
<div class="row">
    <div class="col-md-7">
        <div class="card shadow-sm mb-4">
            <div class="card-header">Descrição do Serviço</div>
            <div class="card-body">
                <form action="{{ url_for('detalhe_orcamento', id=orcamento.id) }}" method="POST">
                    <p><strong>Cliente:</strong> {{ orcamento.cliente.nome_exibicao }}</p>
                    <div class="mb-3"><label class="form-label">Descrição</label><textarea class="form-control" name="descricao" rows="4">{{ orcamento.descricao }}</textarea></div>
                    <div class="mb-3"><label class="form-label">Valor dos Serviços</label><div class="input-group"><span class="input-group-text">R$</span><input type="number" step="0.01" class="form-control" name="valor_servicos" value="{{ '%.2f'|format(orcamento.valor_servicos) }}"></div></div>
                    <button type="submit" class="btn btn-primary w-100" {% if orcamento.status != 'Em Aberto' %}disabled{% endif %}>Salvar Descrição</button>
                </form>
            </div>
        </div>
    </div>
    <div class="col-md-5">
        <div class="card shadow-sm mb-4">
            <div class="card-header">Adicionar Item</div>
            <div class="card-body">
                <form action="{{ url_for('adicionar_item_orcamento', orcamento_id=orcamento.id) }}" method="POST">
                    <div class="mb-2"><label class="form-label">Produto</label><select class="form-select" id="produto_id" name="produto_id" required><option></option>{% for produto in produtos %}<option value="{{ produto.id }}">{{ produto.descricao }} (Estoque: {{ produto.quantidade_estoque }})</option>{% endfor %}</select></div>
                    <div class="row"><div class="col"><label class="form-label">Quantidade</label><input type="number" class="form-control" name="quantidade" value="1" min="1" required></div></div>
                    <button type="submit" class="btn btn-secondary w-100 mt-3" {% if orcamento.status != 'Em Aberto' %}disabled{% endif %}>Adicionar Item</button>
                </form>
            </div>
        </div>
        <div class="card shadow-sm">
            <div class="card-header">Itens do Orçamento</div>
            <div class="card-body">
                <table class="table table-sm"><thead><tr><th>Descrição</th><th class="text-center">Qtd</th><th class="text-end">Total</th><th></th></tr></thead>
                <tbody>
                    {% for item in orcamento.itens %}
                    <tr><td>{{ item.descricao }}</td><td class="text-center">{{ item.quantidade }}</td><td class="text-end">R$ {{ "%.2f"|format(item.valor_total) }}</td>
                        <td class="text-end">
                        {% if orcamento.status == 'Em Aberto' %}
                            <a href="{{ url_for('deletar_item_orcamento', item_id=item.id) }}" class="btn btn-danger btn-sm py-0 px-1">X</a>
                        {% endif %}
                        </td></tr>
                    {% endfor %}
                </tbody></table>
            </div>
        </div>
    </div>
</div>
<div class="row justify-content-end mt-4"><div class="col-md-5"><div class="card shadow-sm"><div class="card-body text-end"><p class="mb-1">Subtotal Serviços: R$ {{ "%.2f"|format(orcamento.valor_servicos) }}</p><p class="mb-2">Subtotal Produtos: R$ {{ "%.2f"|format(orcamento.valor_produtos) }}</p><h4 class="mb-0">Valor Total: <span class="badge bg-primary fs-6">R$ {{ "%.2f"|format(orcamento.valor_total) }}</span></h4></div></div></div></div>
{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() {
        $('#produto_id').select2({ theme: "bootstrap-5", placeholder: "Selecione um produto" });
    });
</script>
{% endblock %}